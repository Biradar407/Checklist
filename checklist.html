<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Road Safety Fortnight Checklist</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg:#e6f7e6;
  --card:#ffffff;
  --accent:#2f6be3;
  --secondary:#374151;
  --warn:#dc2626;
  --share:#10b981;
  --text:#0b1220;
  --muted:#6b7280;
}
body{
  margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);
}
.wrap{
  max-width:800px;margin:18px auto;padding:16px;
}
header{text-align:center;margin-bottom:12px;}
h1{font-size:1.8rem;margin:0;}
.tiny{font-size:0.9rem;color:var(--muted);}
.card{
  background:var(--card);border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(23,32,63,.08);
}
label{
  font-size:1.2rem;color:#222;display:block;margin-bottom:4px;font-weight:600;
}
.input-large{
  width:100%;padding:16px 18px;border-radius:12px;border:1px solid #dfe3ea;background:#fbfdff;font-size:1.25rem;
  text-transform:uppercase;box-sizing:border-box;margin-bottom:10px;
}
textarea{
  width:100%;font-size:1.1rem;padding:10px;min-height:80px;border-radius:10px;border:1px solid #dfe3ea;
  resize:none;box-sizing:border-box;overflow:auto;
}
textarea.autoExpand{overflow:hidden;}
select{
  width:100%;padding:14px 16px;border-radius:10px;border:1px solid #dfe3ea;font-size:1.1rem;margin-bottom:10px;
}
.btn{
  background:var(--accent);color:white;border:0;padding:10px 18px;border-radius:12px;cursor:pointer;font-weight:700;margin-top:12px;font-size:1.15rem;
  transition:0.3s;
}
.btn:hover{opacity:0.85;}
.btn.secondary{background:var(--secondary);}
.btn.warn{background:var(--warn);}
.btn.share{background:var(--share);}
.thumbs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.thumb{width:70px;height:55px;border-radius:6px;overflow:hidden;border:1px solid #e6e9f0}
.thumb img{width:100%;height:100%;object-fit:cover}
.progress-bar{height:10px;background:#d1d5db;border-radius:5px;margin-bottom:12px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);width:0%}
.end-banner{text-align:center;margin-top:20px}
.nav-btns{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;justify-content:center}
.preview-card{background:#fff;padding:12px;border-radius:12px;margin-top:12px;max-height:60vh;overflow:auto;border:1px solid #eef2f7}
.preview-card table{width:100%;border-collapse:collapse;font-size:1rem;margin-bottom:8px}
.preview-card th,.preview-card td{border:1px solid #e6e9f0;padding:8px;vertical-align:top}
.preview-images{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.preview-images img{width:70px;height:55px;object-fit:cover;border-radius:6px;border:1px solid #dcdcdc}
#driverPhotoPreview{width:80px;height:100px;object-fit:cover;border:1px solid #ccc;border-radius:6px;margin-top:6px;}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ROAD SAFETY FORTNIGHT CHECKLIST</h1>
    <div class="tiny">Indane Bottling Plant, Belgaum</div>
  </header>

  <div class="card" id="wizardCard">
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div id="stepContainer"></div>
  </div>
</div>

<script>
const CHECKS = [
  "Whether one time Tool box talk carried out",
  "Whether JRM copy handed over to Crew (in local language)",
  "Whether all junction boxes are properly sealed.",
  "Whether no loose/dangling electrical wiring/terminal available.",
  "Whether fuse box is in good condition",
  "Whether battery is mounted inside the cabin with cover as per OISD-STD-159.",
  "Whether battery terminal are provided with fixed rubber caps.",
  "Whether double pole master switch 300A provided inside cabin.",
  "Whether electrical wiring insulated & protected.",
  "Whether dipole wiring available.",
  "Truck observed without double pole wiring",
  "Truck modified for shifting of batteries inside cabin",
  "Whether cable entries through cabin walls have proper glands/bushes.",
  "Any marks of wear/heat/cut to wiring in engine compartment.",
  "Any inverter provided inside cabin.",
  "Truck is self-starting.",
  "ABS provided & working.",
  "VTS provided & working.",
  "Air brakes not bypassed.",
  "Speed Governor per CMV rules.",
  "All tyres (including spare) in good condition.",
  "Cylinder cage is tight-fit.",
  "If any failure observed, rectification letter issued.",
  "Remarks (If any)"
];

let stepIndex=0, formData={}, imagesCache={}, driverPhoto=null;

function autoExpandTextarea(el){el.style.height='auto'; el.style.height=(el.scrollHeight)+'px';}

function showStep(){
  const container=document.getElementById('stepContainer');
  container.innerHTML='';
  const progress=Math.round((stepIndex/(CHECKS.length+5))*100);
  document.getElementById('progressFill').style.width=progress+'%';

  const today = new Date().toISOString().split('T')[0];

  if(stepIndex===0){
    container.innerHTML=`<label>Truck No</label><input id="truckNo" class="input-large" placeholder="TRUCK NO"><div class="nav-btns"><button class="btn" onclick="nextStep()">Next ➜</button></div>`;
    document.getElementById('truckNo').focus();
  } else if(stepIndex===1){
    container.innerHTML=`<label>Driver Name</label><input id="driverName" class="input-large" placeholder="DRIVER NAME"><div class="nav-btns"><button class="btn secondary" onclick="prevStep()">◀ Previous</button><button class="btn" onclick="nextStep()">Next ➜</button></div>`;
    document.getElementById('driverName').focus();
  } else if(stepIndex===2){
    container.innerHTML=`<label>Driver Photo (ID Size)</label>
      <input type="file" id="driverPhotoInput" accept="image/*" capture="environment">
      <img id="driverPhotoPreview" src="">
      <div class="nav-btns"><button class="btn secondary" onclick="prevStep()">◀ Previous</button><button class="btn" onclick="nextStep()">Next ➜</button></div>`;
    document.getElementById('driverPhotoInput').focus();
    document.getElementById('driverPhotoInput').addEventListener('change', e=>{
      const file=e.target.files[0];
      if(file){
        const reader=new FileReader();
        reader.onload=ev=>{driverPhoto=ev.target.result; document.getElementById('driverPhotoPreview').src=driverPhoto;}
        reader.readAsDataURL(file);
      }
    });
  } else if(stepIndex===3){
    container.innerHTML=`<label>ID No</label><input id="idNo" class="input-large" placeholder="ID NO" inputmode="numeric" pattern="[0-9]*"><div class="nav-btns"><button class="btn secondary" onclick="prevStep()">◀ Previous</button><button class="btn" onclick="nextStep()">Next ➜</button></div>`;
    const idInput=document.getElementById('idNo'); idInput.focus();
    idInput.addEventListener('input',()=>{idInput.value=idInput.value.replace(/\D/g,'');});
  } else if(stepIndex===4){
    container.innerHTML=`<label>Date of Check</label><input id="checkDate" type="date" value="${today}"><div class="nav-btns"><button class="btn secondary" onclick="prevStep()">◀ Previous</button><button class="btn" onclick="nextStep()">Next ➜</button></div>`;
    document.getElementById('checkDate').focus();
  } else if(stepIndex===5){
    container.innerHTML=`<label>Checked By</label>
    <select id="checkedBy">
      <option value="" disabled selected></option>
      <option>Mahantesh B</option>
      <option>Ashok Patil</option>
      <option>Gurunath T</option>
      <option>Sudhir K</option>
      <option>Sunil K</option>
    </select>
    <div class="nav-btns"><button class="btn secondary" onclick="prevStep()">◀ Previous</button><button class="btn" onclick="nextStep()">Next ➜</button></div>`;
    document.getElementById('checkedBy').focus();
  } else if(stepIndex>=6 && stepIndex<6+CHECKS.length){
    const idx=stepIndex-6; imagesCache[idx]=imagesCache[idx]||[];
    container.innerHTML=`
      <div style="font-size:1.2rem;"><b>${idx+1}. ${CHECKS[idx]}</b></div>
      <select id="status_${idx}">
        <option value="" disabled selected></option>
        <option>Found OK</option>
        <option>Not OK</option>
        <option>Yes</option>
        <option>No</option>
        <option>Available</option>
        <option>Not Applicable</option>
      </select>
      <textarea id="remarks_${idx}" class="autoExpand" placeholder="Remarks" oninput="autoExpandTextarea(this)"></textarea>
      <input id="proof_${idx}" type="file" accept="image/*" capture="environment" multiple>
      <div class="thumbs" id="thumbs_${idx}"></div>
      <div class="nav-btns"><button class="btn secondary" onclick="prevStep()">◀ Previous</button><button class="btn" onclick="nextStep()">Next ➜</button></div>`;
    document.getElementById(`status_${idx}`).focus();
    document.getElementById(`proof_${idx}`).addEventListener('change', e=>{
      [...e.target.files].forEach(f=>{
        const r=new FileReader(); r.onload=ev=>{imagesCache[idx].push(ev.target.result); renderThumbs(idx);}; r.readAsDataURL(f);
      });
    });
    renderThumbs(idx);
  } else {
    const rpt=collectReport();
    let rows=rpt.checks.map(c=>{
      const imgs=(c.photos||[]).map(p=>`<img src="${p}">`).join('');
      return `<tr><td>${c.no}</td><td>${c.question}<div class="preview-images">${imgs}</div></td><td>${c.status||'-'}</td><td>${c.remarks||'-'}</td></tr>`;
    }).join('');
    container.innerHTML=`<div class="end-banner"><h2>Preview</h2>
      <div class="preview-card">
        <p><b>Truck:</b> ${rpt.meta.truckNo} | <b>Driver:</b> ${rpt.meta.driverName}</p>
        <p><b>ID:</b> ${rpt.meta.idNo} | <b>Date:</b> ${rpt.meta.checkDate} | <b>Checked By:</b> ${rpt.meta.checkedBy}</p>
        <div><b>Driver Photo:</b><br><img src="${driverPhoto||''}" style="width:80px;height:100px;border:1px solid #ccc;border-radius:6px;"></div>
        <table><tr><th>No</th><th>Check</th><th>Status</th><th>Remarks</th></tr>${rows}</table>
      </div>
      <div class="nav-btns">
        <button class="btn secondary" onclick="prevStep()">◀ Previous</button>
        <button class="btn share" onclick="sharePdf()">📤 Share PDF</button>
        <button class="btn" onclick="downloadPdf()">⬇️ Download PDF</button>
        <button class="btn warn" onclick="clearData()">🗑️ Clear Data</button>
      </div></div>`;
    document.getElementById('progressFill').style.width='100%';
  }
}

function renderThumbs(idx){
  const c=document.getElementById(`thumbs_${idx}`);
  if(!c)return;
  c.innerHTML='';
  imagesCache[idx].forEach(d=>{c.innerHTML+=`<div class="thumb"><img src="${d}"></div>`});
}

function nextStep(){saveStepData(); stepIndex++; showStep();}
function prevStep(){stepIndex--; showStep();}
function saveStepData(){
  if(stepIndex===0) formData.truckNo=document.getElementById('truckNo').value;
  if(stepIndex===1) formData.driverName=document.getElementById('driverName').value;
  if(stepIndex===2){} 
  if(stepIndex===3) formData.idNo=document.getElementById('idNo').value;
  if(stepIndex===4) formData.checkDate=document.getElementById('checkDate').value;
  if(stepIndex===5) formData.checkedBy=document.getElementById('checkedBy').value;
  if(stepIndex>=6&&stepIndex<6+CHECKS.length){
    const i=stepIndex-6;
    formData[`status_${i}`]=document.getElementById(`status_${i}`).value;
    formData[`remarks_${i}`]=document.getElementById(`remarks_${i}`).value;
  }
}

function collectReport(){
  const rpt={meta:{truckNo:formData.truckNo||'',driverName:formData.driverName||'',idNo:formData.idNo||'',checkDate:formData.checkDate||'',checkedBy:formData.checkedBy||'',driverPhoto:driverPhoto||''},checks:[]};
  CHECKS.forEach((q,i)=>{
    rpt.checks.push({
      no:i+1,
      question:q,
      status:formData[`status_${i}`]||'',
      remarks:formData[`remarks_${i}`]||'',
      photos:imagesCache[i]||[]
    });
  });
  return rpt;
}

async function generatePdfBlob(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'mm', format:'a4'});
  const rpt = collectReport();

  // Logo PNG
  const logoUrl='https://upload.wikimedia.org/wikipedia/en/5/5c/Indian_Oil_Corporation_Logo.png';
  let logoImg=null;
  const imgReq=new Promise(resolve=>{
    const img=new Image();
    img.crossOrigin='anonymous';
    img.onload=()=>{logoImg=img; resolve();}
    img.src=logoUrl;
  });
  await imgReq;
  if(logoImg) doc.addImage(logoImg, 'PNG', 14, 10, 30, 15);

  doc.setFontSize(16);
  doc.text('ROAD SAFETY FORTNIGHT CHECKLIST',105,20,null,null,'center');

  doc.setFontSize(12);
  doc.text(`Truck: ${rpt.meta.truckNo}`,14,32);
  doc.text(`Driver: ${rpt.meta.driverName}`,110,32);
  doc.text(`ID: ${rpt.meta.idNo}`,14,40);
  doc.text(`Date: ${rpt.meta.checkDate}`,110,40);
  doc.text(`Checked By: ${rpt.meta.checkedBy}`,14,48);

  if(rpt.meta.driverPhoto){
    doc.addImage(rpt.meta.driverPhoto,'JPEG',150,30,40,50);
  }

  const body = rpt.checks.map(c=>[c.no,c.question,c.status||'-',c.remarks||'-']);
  doc.autoTable({
    startY:85,
    head:[['No','Check','Status','Remarks']],
    body:body,
    styles:{fontSize:10,overflow:'linebreak'},
    headStyles:{fillColor:[47,107,227],textColor:255},
    alternateRowStyles:{fillColor:[240,240,240]},
    columnStyles:{0:{cellWidth:10},1:{cellWidth:100},2:{cellWidth:30},3:{cellWidth:60}},
    margin:{left:14,right:14},
  });

  let y = doc.lastAutoTable.finalY + 8;
  doc.setFontSize(14); doc.text('Defective Section',14,y); y+=6;

  const maxW=65,maxH=65,margin=14;
  let x=margin;
  const pageW=210,pageH=297;
  rpt.checks.forEach(c=>{
    (c.photos||[]).forEach(imgData=>{
      if(x+maxW>pageW-margin){x=margin; y+=maxH+10;}
      if(y+maxH>pageH-margin){doc.addPage(); y=20; x=margin;}
      doc.addImage(imgData,'JPEG',x,y,maxW,maxH);
      doc.setDrawColor(0); doc.rect(x,y,maxW,maxH);
      x+=maxW+6;
    });
  });

  return doc;
}
async function downloadPdf(){
  const doc = await generatePdfBlob();
  doc.save(`Road_Safety_Checklist_${formData.truckNo||'Truck'}.pdf`);
}

async function sharePdf(){
  if(!navigator.canShare||!navigator.canShare({files:[new File([], 'test.pdf')]})){
    alert('Sharing is only supported on mobile or secure HTTPS environments.');
    return;
  }
  const doc = await generatePdfBlob();
  const blob = doc.output('blob');
  const file = new File([blob], `Road_Safety_Checklist_${formData.truckNo||'Truck'}.pdf`, {type:'application/pdf'});
  try{
    await navigator.share({files:[file], title:'Road Safety Checklist', text:'Please find attached.'});
  } catch(e){console.error(e);}
}

function clearData(){
  if(confirm('Clear all data and restart checklist?')){
    stepIndex=0; formData={}; imagesCache={}; driverPhoto=null;
    showStep();
  }
}

// Initial call
showStep();
</script>
</body>
</html>
